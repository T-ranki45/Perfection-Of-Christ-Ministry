<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | Perfection Of Christ Ministry</title>
    <link rel="stylesheet" href="admin.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>
  <body>
    <div class="admin-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-header">
          <i class="fas fa-church"></i>
          <h2>Admin Portal</h2>
        </div>
        <nav class="sidebar-nav">
          <ul>
            <li class="active" onclick="showSection('dashboard')">
              <i class="fas fa-tachometer-alt"></i> Dashboard
            </li>
            <li onclick="showSection('events')">
              <i class="fas fa-images"></i> Manage Services
            </li>
            <li onclick="showSection('messages')">
              <i class="fas fa-video"></i> Manage Messages
            </li>
            <li onclick="showSection('livestream')">
              <i class="fas fa-video"></i> Live Stream
            </li>
            <li onclick="showSection('prayer')">
              <i class="fas fa-praying-hands"></i> Prayer Requests
            </li>
            <li onclick="logout()">
              <i class="fas fa-sign-out-alt"></i> Logout
            </li>
            <li onclick="window.location.href = 'index.html'">
              <i class="fas fa-external-link-alt"></i> View Website
            </li>
          </ul>
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <header class="top-bar">
          <h1>Welcome, Administrator</h1>
          <div class="user-info">
            <span>Admin User</span>
            <div class="avatar"><i class="fas fa-user"></i></div>
          </div>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="content-section active">
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon icon-prayer">
                <i class="fas fa-praying-hands"></i>
              </div>
              <div class="stat-info">
                <h3>Prayer Requests</h3>
                <p id="total-prayers">Loading...</p>
              </div>
            </div>
            <div class="stat-card">
              <div class="stat-icon icon-live">
                <i class="fas fa-video"></i>
              </div>
              <div class="stat-info">
                <h3>Live Status</h3>
                <p id="live-status-text">Checking...</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Events Section -->
        <section id="events" class="content-section">
          <h2>Upcoming Services (Flyers)</h2>
          <div class="card">
            <p class="helper-text">
              Upload flyers for upcoming services. You can select multiple
              images at once.
            </p>
            <form id="add-flyer-form">
              <div
                class="upload-area"
                onclick="document.getElementById('flyer-input').click()"
              >
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Click to Upload Flyers</h3>
                <p>or drag and drop images here</p>
                <input
                  type="file"
                  id="flyer-input"
                  multiple
                  accept="image/*"
                  style="display: none"
                />
              </div>

              <div id="preview-container" class="preview-grid"></div>

              <button type="submit" class="btn-primary">Post Flyers</button>
            </form>
          </div>

          <h3>Current Flyers</h3>
          <div
            id="existing-flyers"
            class="preview-grid"
            style="margin-top: 1rem"
          >
            <!-- Populated by JS -->
          </div>
        </section>

        <!-- Messages Section -->
        <section id="messages" class="content-section">
          <h2>Manage Messages</h2>
          <div class="card">
            <p class="helper-text">
              Post a new message link (e.g., Facebook video) with a thumbnail.
            </p>
            <form id="add-message-form">
              <div class="form-group">
                <label>Message Title</label>
                <input
                  type="text"
                  id="msg-title"
                  required
                  placeholder="e.g. The Power of Faith"
                />
              </div>
              <div class="form-group">
                <label>Preacher</label>
                <input
                  type="text"
                  id="msg-preacher"
                  value="Pastor John Jeremiah"
                />
              </div>
              <div class="form-group">
                <label>Date</label>
                <input type="date" id="msg-date" required />
              </div>
              <div class="form-group">
                <label>Video Link (Facebook/YouTube)</label>
                <input
                  type="url"
                  id="msg-url"
                  required
                  placeholder="https://facebook.com/..."
                />
              </div>
              <div class="form-group">
                <label>Thumbnail Image</label>
                <input type="file" id="msg-image" accept="image/*" required />
              </div>
              <button type="submit" class="btn-primary">Post Message</button>
            </form>
          </div>

          <h3>Recent Messages</h3>
          <div
            id="messages-list"
            class="preview-grid"
            style="margin-top: 1rem"
          ></div>
        </section>

        <!-- Live Stream Section -->
        <section id="livestream" class="content-section">
          <h2>Live Stream Configuration</h2>
          <div class="card">
            <p class="helper-text">
              Enter the Facebook Live URL to update the Live Stream button on
              the homepage.
            </p>
            <form id="livestream-form">
              <div class="form-group">
                <label>Facebook Live Video URL</label>
                <input
                  type="text"
                  id="video-id"
                  placeholder="e.g., https://www.facebook.com/watch/live/?v=..."
                />
                <small>Paste the full URL of the Facebook Live video.</small>
              </div>
              <div class="form-group checkbox-group">
                <input type="checkbox" id="is-live" />
                <label for="is-live"
                  >Mark as Currently Live (Shows "Live" badge on site)</label
                >
              </div>
              <button type="submit" class="btn-primary">Update Stream</button>
            </form>
          </div>
        </section>

        <!-- Prayer Requests Section -->
        <section id="prayer" class="content-section">
          <h2>Incoming Prayer Requests</h2>
          <div class="card no-padding">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Request</th>
                </tr>
              </thead>
              <tbody id="prayer-table-body">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script>
      // Use a relative path for the API URL. This works for both local
      // development (http://localhost:3000/api) and the live server
      // (https://your-app-name.onrender.com/api).
      const API_URL = "/api";

      // --- SECURITY CHECK ---
      if (!localStorage.getItem("admin_token")) {
        window.location.href = "login.html";
      }

      // Navigation Logic
      function showSection(sectionId) {
        document
          .querySelectorAll(".content-section")
          .forEach((el) => el.classList.remove("active"));
        document
          .querySelectorAll(".sidebar-nav li")
          .forEach((el) => el.classList.remove("active"));

        document.getElementById(sectionId).classList.add("active");
        event.currentTarget.classList.add("active");
      }

      function logout() {
        localStorage.removeItem("admin_token");
        window.location.href = "login.html";
      }

      // Fetch Data on Load
      document.addEventListener("DOMContentLoaded", () => {
        loadDashboardStats();
        loadPrayerRequests();
        loadLiveStreamConfig();
        loadFlyersList();
        loadMessagesList();
      });

      async function loadDashboardStats() {
        try {
          const prayersRes = await fetch(`${API_URL}/prayer-requests`);
          const prayers = await prayersRes.json();
          document.getElementById("total-prayers").innerText = prayers.length;
        } catch (e) {
          console.error("Error loading stats", e);
        }
      }

      // --- Flyers Logic ---
      const flyerInput = document.getElementById("flyer-input");
      const previewContainer = document.getElementById("preview-container");
      let selectedFiles = [];

      flyerInput.addEventListener("change", (e) => {
        const files = Array.from(e.target.files);
        selectedFiles = [...selectedFiles, ...files];
        renderPreviews();
      });

      function renderPreviews() {
        previewContainer.innerHTML = "";
        selectedFiles.forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            img.className = "preview-item";
            previewContainer.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      }

      document
        .getElementById("add-flyer-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          if (selectedFiles.length === 0)
            return alert("Please select at least one flyer.");

          // Convert all files to Base64
          const promises = selectedFiles.map((file) => {
            return new Promise((resolve) => {
              const reader = new FileReader();
              reader.onload = (e) => resolve({ image: e.target.result });
              reader.readAsDataURL(file);
            });
          });

          const flyersData = await Promise.all(promises);

          try {
            const res = await fetch(`${API_URL}/flyers`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(flyersData),
            });
            if (res.ok) {
              alert("Flyers Posted Successfully!");
              e.target.reset();
              selectedFiles = [];
              previewContainer.innerHTML = "";
              loadFlyersList(); // Refresh the list
            }
          } catch (err) {
            alert("Failed to post flyers");
          }
        });

      // --- Load & Delete Flyers ---
      async function loadFlyersList() {
        try {
          const res = await fetch(`${API_URL}/flyers`);
          const flyers = await res.json();
          const container = document.getElementById("existing-flyers");
          container.innerHTML = "";

          flyers.forEach((flyer) => {
            const div = document.createElement("div");
            div.className = "flyer-manage-item";
            div.innerHTML = `
                <img src="${flyer.image}" alt="Flyer">
                <button onclick="deleteFlyer('${flyer._id}')" class="delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
            `;
            container.appendChild(div);
          });
        } catch (e) {
          console.error(e);
        }
      }

      async function deleteFlyer(id) {
        if (!confirm("Are you sure you want to delete this flyer?")) return;
        try {
          const res = await fetch(`${API_URL}/flyers/${id}`, {
            method: "DELETE",
          });
          if (res.ok) {
            loadFlyersList();
          } else {
            alert("Failed to delete flyer");
          }
        } catch (e) {
          console.error(e);
        }
      }

      // --- Messages Logic ---
      document
        .getElementById("add-message-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector("button");
          const originalText = btn.innerText;
          btn.innerText = "Posting...";
          btn.disabled = true;

          const title = document.getElementById("msg-title").value;
          const preacher = document.getElementById("msg-preacher").value;
          const date = document.getElementById("msg-date").value;
          const videoUrl = document.getElementById("msg-url").value;
          const fileInput = document.getElementById("msg-image");

          if (fileInput.files.length === 0) {
            alert("Please select a thumbnail image.");
            btn.innerText = originalText;
            btn.disabled = false;
            return;
          }

          const reader = new FileReader();
          reader.readAsDataURL(fileInput.files[0]);
          reader.onload = async () => {
            const image = reader.result;
            try {
              const res = await fetch(`${API_URL}/sermons`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  title,
                  preacher,
                  date,
                  videoUrl,
                  image,
                }),
              });
              if (res.ok) {
                alert("Message Posted Successfully!");
                e.target.reset();
                loadMessagesList();
              } else {
                alert("Failed to post message.");
              }
            } catch (err) {
              console.error(err);
              alert("Error posting message.");
            } finally {
              btn.innerText = originalText;
              btn.disabled = false;
            }
          };
        });

      async function loadMessagesList() {
        try {
          const res = await fetch(`${API_URL}/sermons`);
          const messages = await res.json();
          const container = document.getElementById("messages-list");
          container.innerHTML = messages
            .map(
              (msg) => `
                <div class="flyer-manage-item" style="flex-direction:column; align-items: flex-start; gap: 0.5rem;">
                    <img src="${msg.image}" alt="${msg.title}" style="width:100%; height: 120px; object-fit:cover;">
                    <div style="font-size:0.9rem; font-weight:bold;">${msg.title}</div>
                    <div style="font-size:0.8rem; color:#666;">${msg.date}</div>
                    <button onclick="deleteMessage('${msg._id}')" class="delete-btn" style="position:absolute; top:5px; right:5px;"><i class="fas fa-trash"></i></button>
                </div>
            `,
            )
            .join("");
        } catch (e) {
          console.error(e);
        }
      }

      async function deleteMessage(id) {
        if (!confirm("Delete this message?")) return;
        try {
          const res = await fetch(`${API_URL}/sermons/${id}`, {
            method: "DELETE",
          });
          if (res.ok) {
            loadMessagesList();
          } else {
            alert(
              "Failed to delete message. The server might have restarted or the item was already removed.",
            );
          }
        } catch (e) {
          console.error(e);
          alert("An error occurred while trying to delete the message.");
        }
      }

      // --- Live Stream Logic ---
      async function loadLiveStreamConfig() {
        try {
          const res = await fetch(`${API_URL}/livestream`);
          const config = await res.json();
          document.getElementById("video-id").value = config.videoId;
          document.getElementById("is-live").checked = config.isLive;
          document.getElementById("live-status-text").innerText = config.isLive
            ? "LIVE NOW"
            : "Offline";
          document.getElementById("live-status-text").style.color =
            config.isLive ? "red" : "#666";
        } catch (e) {
          console.error(e);
        }
      }

      document
        .getElementById("livestream-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const videoId = document.getElementById("video-id").value;
          const isLive = document.getElementById("is-live").checked;

          try {
            const res = await fetch(`${API_URL}/livestream`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ videoId, isLive }),
            });
            if (res.ok) {
              alert("Live Stream Updated!");
              loadLiveStreamConfig();
            }
          } catch (err) {
            alert("Failed to update stream");
          }
        });

      // --- Prayer Requests Logic ---
      async function loadPrayerRequests() {
        try {
          const res = await fetch(`${API_URL}/prayer-requests`);
          const requests = await res.json();
          const tbody = document.getElementById("prayer-table-body");
          tbody.innerHTML = "";

          if (requests.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="4" style="text-align:center">No prayer requests yet.</td></tr>';
            return;
          }

          requests.forEach((req) => {
            const date = new Date(req.timestamp).toLocaleDateString();
            const row = `
                        <tr>
                            <td>${date}</td>
                            <td>${req.name}</td>
                            <td>${req.email}</td>
                            <td>${req.request}</td>
                        </tr>
                    `;
            tbody.innerHTML += row;
          });
        } catch (e) {
          console.error(e);
        }
      }
    </script>
  </body>
</html>
